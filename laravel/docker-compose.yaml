version: '3.7'

services:
  mysql:
    networks:
      - net
    image: mysql:5.7
    ports:
      - 3056:3306
    volumes:
      - db:/var/lib/mysql
    environment:
      - MYSQL_DATABASE=garmoth
      - MYSQL_USER=garmoth
      - MYSQL_PASSWORD=pwd
      - MYSQL_ALLOW_EMPTY_PASSWORD=true

  nginx:
    image: nginx:1.19.2-alpine
    networks:
      - net
    ports:
#      - 3050:80
      - 3050:443
    depends_on:
      - php
    volumes:
      - ./:/usr/share/nginx/html
    secrets:
      - source: conf
        target: /etc/nginx/conf.d/default.conf
      - source: ssl_cert
        target: /etc/nginx/ssl_certs/cert.pem
      - source: ssl_key
        target: /etc/nginx/ssl_certs/key.pem

  php:
    build:
      context: .
      dockerfile: docker/php/local.Dockerfile
    networks:
      - net
    depends_on:
      - mysql
    environment:
      - COMPOSER_CACHE_DIR=/usr/share/nginx/html/storage/cache/.composer
    volumes:
      - ./:/usr/share/nginx/html

  redis:
    image: redis:5-alpine
    networks:
      - net

volumes:
  db: { }

networks:
  net: { }

secrets:
  conf:
    file: ./docker/nginx/nginx.conf
  ssl_cert:
    file: ./docker/certs/cert.pem
  ssl_key:
    file: ./docker/certs/key.pem
